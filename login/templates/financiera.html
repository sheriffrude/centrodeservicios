<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>


</head>

<body>
    <div>
        <label for="datepicker-start">Desde:</label>
        <input type="text" id="datepicker-start" placeholder="yyyy-mm-dd">
        <label for="datepicker-end">Hasta:</label>
        <input type="text" id="datepicker-end" placeholder="yyyy-mm-dd">
        <button id="filter-btn">Filtrar</button>
    </div>
<div>
    <input type="text" name="daterange" value="01/01/2018 - 01/15/2018" />
</div>
    <div>
        <button id="export-pdf">Exportar a PDF</button>
        <button id="export-excel">Exportar a Excel</button>
    </div>
    <div>
        <select id="grupo-granja-selector">
            <option value="Agrojabar">Agrojabar</option>
            <option value="Agrocerdos">Agrocerdos</option>
            <option value="campeon">campeon</option>
            <option value="Gamm">Gamm</option>
            <option value="CER">CER</option>
            <option value="HBM">HBM</option>
        </select>
        <button id="generate-report-btn">Generar Reporte por grupo</button>
    </div>

    <div>
        <label for="">BUSCAR POR CONSECUTIVO, REMISION O CLIENTE: </label><input type="text" id="search-input"
            placeholder="Buscar ">

    </div>

    <table id="example1" class="table table-bordered table-striped table-responsive">
        <thead>
            <tr>
                <th>Fecha Transformación</th>
                <th>Unidades</th>
                <th>Peso Canal Fría</th>
                <th>Consecutivo Cercafe</th>
                <th>Código Granja</th>
                <th>Remisión</th>
                <th>Valor</th>
                <th>Cliente</th>
                <th>Planta Beneficio</th>
                <th>Granja</th>
                <th>Nit Asociado</th>
                <th>Asociado</th>
                <th>Grupo Granja</th>
                <th>Retención</th>
                <th>Valor a Pagar Asociado</th>
                <th>Valor Kilo</th>
            </tr>
        </thead>
        <tbody>
            <!-- Los datos se llenarán aquí -->
        </tbody>
    </table>
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <!-- Agrega la biblioteca jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Agrega la biblioteca DataTables JS -->
    <script type="text/javascript" charset="utf8"
        src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>


    <script>
        $(document).ready(function () {
            // Inicializar los datepickers
            $("#datepicker-start").datepicker({
                dateFormat: 'yy/mm/dd'
            });
            $("#datepicker-end").datepicker({
                dateFormat: 'yy/mm/dd'
            });

            // Al hacer clic en el botón Filtrar
            $("#filter-btn").click(function () {
                // Obtener las fechas seleccionadas
                var startDate = $("#datepicker-start").val();
                var endDate = $("#datepicker-end").val();

                // Hacer la solicitud AJAX con las fechas como parámetros
                $.ajax({
                    url: '/repfinan/',
                    type: 'GET',
                    data: {
                        start_date: startDate,
                        end_date: endDate,

                    },
                    success: function (response) {
                        // Limpiar la tabla
                        $('#example1 tbody').empty();

                        // Agregar las filas con los datos
                        response.data.forEach(function (compromiso) {
                            $('#example1 tbody').append('<tr data-id="' + compromiso.Consecutivo_Cercafe + '"><td>' + compromiso.Fecha_transformacion + '</td><td>' + compromiso.Unidades + '</td><td>' + compromiso.Peso_canal_fria + '</td><td>' + compromiso.Consecutivo_Cercafe + '</td><td>' + compromiso.Codigo_granja + '</td><td>' + compromiso.Remision + '</td><td>' + compromiso.Valor + '</td><td>' + compromiso.Cliente + '</td><td>' + compromiso.Planta_Beneficio + '</td><td>' + compromiso.Granja + '</td><td>' + compromiso.Nit_asociado + '</td><td>' + compromiso.Asociado + '</td><td>' + compromiso.Grupo_Granja + '</td><td>' + compromiso.Retencion + '</td><td>' + compromiso.Valor_a_pagar_asociado + '</td> <td contenteditable=true class="editable">' + compromiso.Valor_kilo + '</td><td><button class="save-btn">Guardar</button></td></tr>');

                        });
                        $('#example1').DataTable({
                            "paging": true,
                            "pageLength": 20
                        });

                    }
                });
            });
        });
        $("#export-pdf").click(function () {
            $.ajax({
                url: '/export-pdf/',
                type: 'GET',
                data: {
                    start_date: $("#datepicker-start").val(),
                    end_date: $("#datepicker-end").val(),

                },
                success: function (response) {
                    // Abrir el PDF en una nueva pestaña
                    window.open(response.url, '_blank');
                }
            });
        });

        // Exportar a Excel
        $("#export-excel").click(function () {
            $.ajax({
                url: '/export-excel/',
                type: 'GET',
                data: {
                    start_date: $("#datepicker-start").val(),
                    end_date: $("#datepicker-end").val(),

                },
                success: function (response) {
                    // Descargar el archivo Excel
                    var a = document.createElement('a');
                    a.href = response.url;
                    a.download = 'reporte.xlsx';
                    a.click();
                }
            });
        });
        $(document).ready(function () {
            // ... otros códigos

            // Evento click para el botón de guardar
            $("body").on("click", ".save-btn", function () {
                // Obtener el valor modificado
                var newValue = $(this).closest("tr").find(".editable").text();
                // Obtener el ID de la fila
                var id = $(this).closest("tr").data("id");

                var csrfToken = $("[name=csrfmiddlewaretoken]").val();
                // Hacer la solicitud AJAX para guardar los cambios
                $.ajax({
                    url: '/save-changes/',
                    type: 'POST',
                    data: {
                        id: id,
                        newValue: newValue,
                        csrfmiddlewaretoken: csrfToken
                    },
                    success: function (response) {
                        // Si la operación fue exitosa, actualizar la tabla
                        if (response.success) {
                            alert('Cambios guardados exitosamente.');
                        } else {
                            alert('Error al guardar los cambios.');
                        }
                    }
                });
            });
        });
        $(".editable").on("input", function () {
            // Obtener el valor actual del campo
            var currentValue = $(this).text();

            // Eliminar todos los caracteres que no sean números
            var newValue = currentValue.replace(/[^0-9]/g, '');

            // Establecer el nuevo valor en el campo
            $(this).text(newValue);
        });
        $("#search-input").on("input", function () {
            // Obtener el texto de búsqueda
            var searchText = $(this).val().toLowerCase();

            // Filtrar las filas de la tabla
            $("#example1 tbody tr").each(function () {
                // Obtener los valores de las columnas relevantes
                var consecutivoCercafe = $(this).find("td:nth-child(4)").text().toLowerCase();
                var remision = $(this).find("td:nth-child(6)").text().toLowerCase();
                var cliente = $(this).find("td:nth-child(8)").text().toLowerCase();

                // Ocultar o mostrar la fila según el texto de búsqueda
                if (consecutivoCercafe.indexOf(searchText) > -1 || remision.indexOf(searchText) > -1 || cliente.indexOf(searchText) > -1) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Evento click para el botón de generar informe en Excel
        $("#generate-report-btn").click(function () {
            // Obtener el valor seleccionado del selector de opciones
            var selectedGroup = $("#grupo-granja-selector").val();

            // Hacer la solicitud AJAX para generar el informe en Excel
            $.ajax({
                url: '/generate-excel-report/',
                type: 'GET',
                data: {
                    start_date: $("#datepicker-start").val(),
                    end_date: $("#datepicker-end").val(),
                    selected_group: selectedGroup
                },
                success: function (response) {
                    // Descargar el archivo Excel
                    var a = document.createElement('a');
                    a.href = response.url;
                    a.download = 'reporte_grupo_' + selectedGroup + '.xlsx';
                    a.click();


                }
            });
        });
        



    </script>
</body>

</html>